#!/bin/bash

# ==============================================================================
# Hesutils library: dnsmasq configuration writer
# ==============================================================================


# Generate the Hesiod records
# ------------------------------------------------------------------------------

function gen_dnsmasq {

    # open the redirection to the output file
    if (( dryrun )) ; then
        exec 3>&1
    else
        exec 3>"${tmpdir}/$(basename "$DNSMASQPATH")"
    fi

    (( verbose )) && echo -e "\nGenerating the temporary dnsmasq configuration file: ${tmpdir}/$(basename "$DNSMASQPATH")\n"

    echo -e "# Generated by hesutils on $(date)\n" >&3

    # block what needs to be blocked
    (( BLOCKUPSTREAM )) && echo "local=/${HESDOMAIN}/" >&3
    (( BLOCKATHENA )) && echo "local=/ns.athena.mit.edu/" >&3

    echo >&3


    # dnsmasq doesn't support CNAMEs so we need to repeat the TXT records twice:
    # .user and .UID, and .group and .GID...

    # user and UID records first
    for uid in ${!uid2user[@]} ; do
        user=${uid2user[$uid]}
        while read line ; do
            for i in ${user}.passwd ${uid}.uid ; do
                printf 'txt-record=%s.%s,"%s"\n' $i $HESDOMAIN "$line" >&3
            done
        done < <(echo ${hesusers[$user]} | sanitize_TXT)
    done

    echo >&3


    # then group and GID records
    for gid in ${!gid2group[@]} ; do
        group=${gid2group[$gid]}
        while read line ; do
            for i in ${group}.group ${gid}.gid ; do
                printf 'txt-record=%s.%s,"%s"\n' $i $HESDOMAIN "$line" >&3
            done
        done < <(echo ${hesgroups[$group]} | sanitize_TXT)
    done

    echo >&3


    # then grplist records
    for uid in ${!uid2user[@]} ; do
        user=${uid2user[$uid]}
        while read line ; do
            printf 'txt-record=%s.%s,"%s"\n' ${user}.grplist $HESDOMAIN "$line" >&3
        done < <(echo ${grplists[$user]} | sanitize_TXT)
    done

    echo >&3


    # and finally filsys records
    if (( FILSYS )) ; then
        for uid in ${!uid2user[@]} ; do
            user=${uid2user[$uid]}
            while read line ; do
                # skip empty lines due to trailing carriage returns
                (( ${#line} )) || continue
                printf 'txt-record=%s.%s,"%s"\n' ${user}.filsys $HESDOMAIN "$line" >&3
            done < <(echo -e ${filsys[$user]} | sanitize_TXT)

        done
    fi

    echo >&3


    # close the redirection
    exec 3>&-

    # install the file to its location
    (( dryrun )) || install_file "${tmpdir}/$(basename "$DNSMASQPATH")" "$DNSMASQPATH"

    # return code will be 0 if dryrun, or the return code of install_file if not
}



# Restart the server
# ------------------------------------------------------------------------------

function restart_dnsmasq {

    # dnsmasq doesn't re-read the configuration files on SIGHUP...
    # try systemd:
    (( dryrun )) || systemctl restart dnsmasq || echo "WARNING: couldn't restart dnsmasq." >&2
}

