#!/usr/bin/env bash

# ==============================================================================
#
# Functions to write out the Hesiod TXT records in different formats.
#
# ==============================================================================
#
# This file is part of Hesutils <https://gitlab.com/jflf/hesutils>
# Hesutils Copyright (c) 2019-2021 JFLF
#
# Hesutils is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Hesutils is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Hesutils. If not, see <https://www.gnu.org/licenses/>.
#
# ==============================================================================



# Text utilities
# ------------------------------------------------------------------------------

# Make sure any double quote within a string is properly escaped.

function sanitize_TXT { sed 's/"/\\\\"/g' ; }



# Generate the Hesiod records
# ------------------------------------------------------------------------------

function hes_output {

    echo -e "${COMMENT} Generated by hesgen on $(date)\n"

    # block what needs to be blocked
    case $OUTPUTFMT in
        dnsmasq )
            (( BLOCKUPSTREAM )) && echo "local=/${HESDOMAIN}/"
            (( BLOCKATHENA )) && echo "local=/ns.athena.mit.edu/"
            echo
            ;;
    esac


    # We're going to redirect stdout to column for pretty-printing
    # First save current stdout to descriptor 9
    exec 9>&1
    # Then redirect stdout
    exec 1>&>(column -tes $'\t')


    #\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\
    #
    #   EVERYTHING BELOW THIS LINE IS PRINTED OUT THROUGH COLUMN!
    #
    #   Column's separator is tab. Use '\t' in your printf and echo -e.
    #   Do not mix output through column with direct writes to descriptor 9 or
    #   the line order will be lost.
    #
    #\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\


    # Notes:
    # - numerical indices (eg. ${!uid2user[@]}) are sorted automatically
    # - dnsmasq doesn't support CNAMEs and unbound doesn't expand them, so we
    #   need to repeat the TXT records twice: .user + .UID, .group + .GID...


    # user and UID records first
    echo "${COMMENT} Users"

    for uid in ${!uid2user[@]} ; do
        user=${uid2user[$uid]}
        while read line ; do

            case $OUTPUTFMT in
                dnsmasq )
                    printf 'txt-record=%s.%s,"%s"\n' ${user}.passwd $HESDOMAIN "$line"
                    printf 'txt-record=%s.%s,"%s"\n' ${uid}.uid $HESDOMAIN "$line"
                    ;;
                unbound )
                    printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${user}.passwd $HESDOMAIN "$line"
                    printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${uid}.uid $HESDOMAIN "$line"
                    ;;
                bind )
                    printf $'%s\tIN\tTXT\t"%s"\n' ${user}.passwd "$line"
                    printf $'%s\tIN\tCNAME\t%s\n' ${uid}.uid ${user}.passwd
                    ;;
            esac

        done < <(echo ${hesusers[$user]} | sanitize_TXT)
    done

    echo


    # then group and GID records
    echo "${COMMENT} Groups"

    for gid in ${!gid2group[@]} ; do
        group=${gid2group[$gid]}
        while read line ; do

            case $OUTPUTFMT in
                dnsmasq )
                    printf 'txt-record=%s.%s,"%s"\n' ${group}.group $HESDOMAIN "$line"
                    printf 'txt-record=%s.%s,"%s"\n' ${gid}.gid $HESDOMAIN "$line"
                    ;;
                unbound )
                    printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${group}.group $HESDOMAIN "$line"
                    printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${gid}.gid $HESDOMAIN "$line"
                    ;;
                bind )
                    printf $'%s\tTXT\t"%s"\n' ${group}.group "$line"
                    printf $'%s\tCNAME\t%s\n' ${gid}.gid ${group}.group
                    ;;
            esac

        done < <(echo ${hesgroups[$group]} | sanitize_TXT)
    done

    echo


    # then grplist records
    echo "${COMMENT} Group lists"

    for uid in ${!uid2user[@]} ; do
        user=${uid2user[$uid]}
        while read line ; do

            case $OUTPUTFMT in
                dnsmasq )
                    printf 'txt-record=%s.%s,"%s"\n' ${user}.grplist $HESDOMAIN "$line"
                    ;;
                unbound )
                    printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${user}.grplist $HESDOMAIN "$line"
                    ;;
                bind )
                    printf $'%s\tIN\tTXT\t"%s"\n' ${user}.grplist "$line"
                    ;;
            esac

        done < <(echo ${grplists[$user]} | sanitize_TXT)
    done

    echo


    # and finally filsys records
    if (( FILSYS )) ; then
        echo "${COMMENT} Filesystems"

        for uid in ${!uid2user[@]} ; do
            user=${uid2user[$uid]}
            while read line ; do
                # skip empty lines due to trailing carriage returns
                (( ${#line} )) || continue

                case $OUTPUTFMT in
                    dnsmasq )
                        printf 'txt-record=%s.%s,"%s"\n' ${user}.filsys $HESDOMAIN "$line"
                        ;;
                    unbound )
                        printf $'local-data:\t\'%s.%s\tTXT\t"%s"\'\n' ${user}.filsys $HESDOMAIN "$line"
                        ;;
                    bind )
                        printf $'%s\tIN\tTXT\t"%s"\n' ${user}.filsys "$line"
                        ;;
                esac

            done < <(echo "${filsys[$user]}" | sanitize_TXT)

        done
    fi


    # Finally, restore stdout and close descriptor 9
    exec 1>&9 9>&-
}

